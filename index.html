<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>ระบบบันทึกซ่อมบำรุง ATV</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#22c55e">

  <style>
    /* === UI เดิมของคุณ (ไม่แก้) === */
    *{box-sizing:border-box;font-family:system-ui,-apple-system,"Segoe UI",sans-serif}
    body{margin:0;background:#0f172a;color:#e5e7eb}
    .app{max-width:1200px;margin:auto;padding:20px 16px 40px}
    h1,h2,h3{margin:0 0 12px;color:#f9fafb}
    h1{font-size:1.8rem}
    h2{font-size:1.3rem}
    h3{font-size:1rem}
    .subtitle{font-size:.9rem;color:#9ca3af;margin-bottom:16px}
    .grid{display:grid;grid-template-columns:1.1fr 1.4fr;gap:16px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:#020617;border-radius:18px;padding:16px;border:1px solid #1f2937}
    .card-header{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
    label{font-size:.8rem;color:#9ca3af;display:block;margin-bottom:4px}
    input,textarea,select{width:100%;padding:7px 9px;border-radius:10px;border:1px solid #374151;background:#020617;color:#e5e7eb;font-size:.85rem}
    textarea{min-height:60px}
    .btn{border-radius:999px;border:none;padding:8px 16px;cursor:pointer;font-size:.85rem}
    .btn-primary{background:linear-gradient(135deg,#22c55e,#22d3ee);color:#020617;font-weight:600}
    .btn-ghost{background:transparent;color:#9ca3af;border:1px solid #374151}
    .btn-danger{background:transparent;color:#f97373;border:1px solid #4b1212}
    table{width:100%;border-collapse:collapse;font-size:.78rem}
    th,td{padding:6px;border-bottom:1px solid #111827}
    .empty-state{padding:14px;text-align:center;color:#6b7280}
  </style>
</head>

<body>
<div class="app">
  <h1>ระบบบันทึกซ่อมบำรุง ATV</h1>
  <div class="subtitle">Realtime ข้ามเครื่องด้วย Firebase Firestore</div>

  <main class="grid">
    <section>
      <div class="card">
        <div class="card-header">
          <h2>ข้อมูลรถ</h2>
          <button class="btn btn-ghost" id="btnClearVehicle">ลบรถ</button>
        </div>

        <label>ชื่อรถ</label>
        <input id="vehicleName">

        <label>ยี่ห้อ</label>
        <input id="vehicleBrand">

        <label>รุ่น</label>
        <input id="vehicleModel">

        <button class="btn btn-primary" id="btnSaveVehicle">บันทึกข้อมูลรถ</button>
      </div>

      <div style="height:10px"></div>

      <div class="card">
        <h2>เพิ่มรายการซ่อม</h2>
        <form id="logForm">
          <label>วันที่</label>
          <input type="date" id="logDate" required>

          <label>งานที่ทำ</label>
          <textarea id="logWork"></textarea>

          <label>ค่าใช้จ่าย</label>
          <input type="number" id="logCost">

          <button class="btn btn-primary" type="submit">เพิ่ม</button>
        </form>
      </div>
    </section>

    <section>
      <div class="card">
        <h2>ประวัติการซ่อม</h2>
        <table>
          <thead>
            <tr><th>วันที่</th><th>งาน</th><th>ค่าใช้จ่าย</th></tr>
          </thead>
          <tbody id="logTable"></tbody>
        </table>
        <div id="emptyState" class="empty-state">ยังไม่มีข้อมูล</div>
      </div>
    </section>
  </main>
</div>

<!-- ================= LOCAL STORE ================= -->
<script>
const MULTI_KEY="atv_multi_store";
function getStore(){
  try{const r=localStorage.getItem(MULTI_KEY);if(r)return JSON.parse(r)}catch(e){}
  return{vehicles:{},current:""}
}
function setStoreLocal(s){localStorage.setItem(MULTI_KEY,JSON.stringify(s))}
function ensureCurrent(){
  const s=getStore();
  if(!s.current)s.current=Object.keys(s.vehicles)[0]||"";
  setStoreLocal(s);return s.current;
}
</script>

<!-- ================= UI LOGIC ================= -->
<script>
const vName=vehicleName,vBrand=vehicleBrand,vModel=vehicleModel;
const logTable=document.getElementById("logTable");
const emptyState=document.getElementById("emptyState");

function render(){
  const s=getStore(),cur=ensureCurrent();
  if(!cur||!s.vehicles[cur]){logTable.innerHTML="";emptyState.style.display="block";return}
  const logs=s.vehicles[cur].logs||[];
  logTable.innerHTML="";
  emptyState.style.display=logs.length?"none":"block";
  logs.forEach(l=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${l.date}</td><td>${l.work}</td><td>${l.cost}</td>`;
    logTable.appendChild(tr);
  });
}

btnSaveVehicle.onclick=()=>{
  const name=vName.value.trim();
  if(!name)return alert("ใส่ชื่อรถ");
  const s=getStore();
  s.vehicles[name]=s.vehicles[name]||{info:{},logs:[]};
  s.vehicles[name].info={name,brand:vBrand.value,model:vModel.value};
  s.current=name;
  setStore(s);
  alert("บันทึกแล้ว");
};

btnClearVehicle.onclick=()=>{
  const s=getStore(),cur=ensureCurrent();
  if(!cur)return;
  if(!confirm("ลบรถคันนี้?"))return;
  delete s.vehicles[cur];
  s.current="";
  setStore(s);
  render();
};

logForm.onsubmit=e=>{
  e.preventDefault();
  const s=getStore(),cur=ensureCurrent();
  if(!cur)return;
  s.vehicles[cur].logs.push({
    date:logDate.value,
    work:logWork.value,
    cost:Number(logCost.value||0)
  });
  setStore(s);
  logForm.reset();
  render();
};

render();
</script>

<!-- ================= FIREBASE REALTIME (SAFE) ================= -->
<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import{getFirestore,doc,setDoc,onSnapshot}from"https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig={
  apiKey:"AIzaSyD6VXnzEBt0F6uzArAUbGloP3iWzVq8Qp8",
  authDomain:"atv-maintenance-387e9.firebaseapp.com",
  projectId:"atv-maintenance-387e9",
};
const app=initializeApp(firebaseConfig);
const db=getFirestore(app);
const REF=doc(db,"atv","multi_store");

let applyingRemote=false;

onSnapshot(REF,snap=>{
  if(!snap.exists())return;
  applyingRemote=true;
  localStorage.setItem("atv_multi_store",JSON.stringify(snap.data()));
  render();
  applyingRemote=false;
});

window.setStore=async function(s){
  setStoreLocal(s);
  if(applyingRemote)return;
  try{await setDoc(REF,s,{merge:true})}catch(e){console.error(e)}
};
</script>

<!-- ================= DISABLE SERVICE WORKER ================= -->
<script>
if('serviceWorker'in navigator){
  navigator.serviceWorker.getRegistrations().then(r=>r.forEach(reg=>reg.unregister()));
}
</script>

</body>
</html>
